
import config from '../config.cjs';

const report = async (m, gss) => {
  try {
    const prefix = config.PREFIX;
    const cmd = m.body.startsWith(prefix) ? m.body.slice(prefix.length).split(' ')[0].toLowerCase() : '';
    const text = m.body.slice(prefix.length + cmd.length).trim();
    const validCommands = ['cal', 'calculater', 'calc'];

    if (validCommands.includes(cmd)) {
      let id = m.from;
      gss.math = gss.math ? gss.math : {};
      if (id in gss.math) {
        clearTimeout(gss.math[id][3]);
        delete gss.math[id];
        let responseMessage = '...';
        return await gss.sendMessage(m.from, {
          text: " ",
          contextInfo: {
            externalAdReply: {
              title: `ðŸ‘‹hy ${m.pushName}`,
              body: responseMessage,
              thumbnailUrl: "https://raw.githubusercontent.com/NjabuloJf/Njabulo-Jb/main/public/fana.jpg",
              mediaType: 1,
              renderLargerThumbnail: false,
              sourceUrl: "https://github.com/NjabuloJf/Njabulo-Jb",
            }
          }
        }, { quoted: m });
      }

      let val = text
        .replace(/[^0-9\-\/+*Ã—Ã·Ï€Ee()piPI.]/g, '') // Allow decimal point '.'
        .replace(/Ã—/g, '*')
        .replace(/Ã·/g, '/')
        .replace(/Ï€|pi/gi, 'Math.PI')
        .replace(/e/gi, 'Math.E')
        .replace(/\/+/g, '/')
        .replace(/\++/g, '+')
        .replace(/-+/g, '-');

      let format = val
        .replace(/Math\.PI/g, 'Ï€')
        .replace(/Math\.E/g, 'e')
        .replace(/\//g, 'Ã·')
        .replace(/\*/g, 'Ã—');

      let result = (new Function('return ' + val))();
      if (isNaN(result)) throw new Error('example: 17+19');

      let responseMessage = `*${format}* = _${result}_`;
      await gss.sendMessage(m.from, {
        text: " ",
        contextInfo: {
          externalAdReply: {
            title: `ðŸ‘‹hy ${m.pushName}`,
            body: responseMessage,
            thumbnailUrl: "https://raw.githubusercontent.com/NjabuloJf/Njabulo-Jb/main/public/fana.jpg",
            mediaType: 1,
            renderLargerThumbnail: false,
            sourceUrl: "https://github.com/NjabuloJf/Njabulo-Jb",
          }
        }
      }, { quoted: m });
    }
  } catch (error) {
    // Handle specific error messages
    if (error instanceof SyntaxError) {
      let responseMessage = 'Invalid syntax. Please check your expression.';
      await gss.sendMessage(m.from, {
        text: " ",
        contextInfo: {
        isForwarded: true,
          forwardedNewsletterMessageInfo: {
          newsletterJid: config.ID_CHANNEL,
          newsletterName: "â•­â€¢â€¢âž¤GWM-XMD",
          serverMessageId: 143,
         },
          forwardingScore: 999,
          externalAdReply: {
            title: "I am GWM-XMD for assistant ui",
            body: responseMessage,
            thumbnailUrl: "https://raw.githubusercontent.com/NjabuloJf/Njabulo-Jb/main/public/fanaa.jpg",
            mediaType: 1,
            renderLargerThumbnail: false,
            sourceUrl: "https://github.com/NjabuloJf/Njabulo-Jb",
          }
        }
      }, { quoted: m });
    } else if (error instanceof Error) {
      let responseMessage = error.message;
      await gss.sendMessage(m.from, {
        text: " ",
        contextInfo: {
        isForwarded: true,
          forwardedNewsletterMessageInfo: {
          newsletterJid: config.ID_CHANNEL,
          newsletterName: "â•­â€¢â€¢âž¤GWM-XMD",
          serverMessageId: 143,
         },
          forwardingScore: 999,
          externalAdReply: {
            title: "I am GWM-XMD for assistant ui",
            body: responseMessage,
            thumbnailUrl: "https://raw.githubusercontent.com/NjabuloJf/Njabulo-Jb/main/public/fanaa.jpg",
            mediaType: 1,
            renderLargerThumbnail: false,
            sourceUrl: "https://github.com/NjabuloJf/Njabulo-Jb",
          }
        }
      }, { quoted: m });
    } else {
    }
  }
};

export default report;
